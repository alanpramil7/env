#!/usr/bin/env bash
#
# Main environment setup script that orchestrates the execution of all component scripts.
# This script calls other scripts to set up various aspects of the environment.
#
# Usage: ENV_DIR=/path/to/env ./env

# Check if ENV_DIR variable is set
if [ -z "$ENV_DIR" ]; then
	echo "Error: ENV_DIR variable is not set."
	echo "Usage: ENV_DIR=/path/to/env ./env"
	exit 1
fi

# Ensure ENV_DIR exists
if [ ! -d "$ENV_DIR" ]; then
	echo "Error: Directory $ENV_DIR does not exist."
	exit 1
fi

# Function to run a script and check its exit status
run_script() {
	local script="$ENV_DIR/$1"
	echo "Running $script..."
	
	if [ ! -f "$script" ]; then
		echo "Error: Script $script not found."
		return 1
	fi
	
	if [ ! -x "$script" ]; then
		echo "Error: Script $script is not executable. Setting permissions..."
		chmod +x "$script" || { echo "Failed to set executable permissions on $script"; return 1; }
	fi
	
	"$script"
	local status=$?
	
	if [ $status -ne 0 ]; then
		echo "Error: $script failed with exit code $status."
		return $status
	fi
	
	echo "Completed $script successfully."
	return 0
}

# Install basic programs
run_script "programs" || exit 1

# Install yay package manager
run_script "yay" || exit 1

# Configure keyd for keyboard remapping
run_script "keyd" || exit 1

# Configure git
run_script "git" || exit 1

# Set up zsh shell
run_script "zsh" || exit 1

# Create symlinks for configuration files
run_script "symlinks" || exit 1

echo "Environment setup completed successfully!"
exit 0